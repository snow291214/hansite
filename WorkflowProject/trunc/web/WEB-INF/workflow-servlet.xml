<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">
    
    <bean class="org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"/>

    <bean id="propertyConfigurer"
          class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"
          p:location="/WEB-INF/classes/mail.properties"/>

    <!--
    Most controllers will use the ControllerClassNameHandlerMapping above, but
    for the index controller we are using ParameterizableViewController, so we must
    define an explicit mapping for it.
    -->
    <bean id="urlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
        <property name="mappings">
            <props>
                <prop key="index.htm">indexController</prop>
                <prop key="logout.htm">logoutController</prop>
                <prop key="download.htm">downloadController</prop>
                <prop key="selectUsers.htm">selectUsersFormController</prop>
                <prop key="registerTask.htm">newTaskFormController</prop>
                <prop key="upload.htm">uploadController</prop>
                <prop key="success.htm">successController</prop>
                <prop key="authentication.htm">loginFormController</prop>
                <prop key="assignedTask.htm">assignedTaskViewController</prop>
                <prop key="completedTask.htm">completedTaskController</prop>
                <prop key="assignTask.htm">assingTaskFormController</prop>
                <prop key="workflowManager.htm">workflowManagerFormController</prop>
                <prop key="executionRequest.htm">executionRequestController</prop>
            </props>
        </property>
    </bean>
    
    <bean id="viewResolver"
          class="org.springframework.web.servlet.view.InternalResourceViewResolver"
          p:prefix="/WEB-INF/jsp/"
          p:suffix=".jsp" />
      
    <!--========================= Controllers ===============================-->

    <!-- Index Controller -->
    <bean name="indexController" class="ru.sgnhp.web.IndexController" >
        <property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>
    </bean>

    <!-- Execution Request Controller -->
    <bean name="executionRequestController" class="ru.sgnhp.web.ExecutionRequestController">
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!-- Download Controller -->
    <bean name="downloadController" class="ru.sgnhp.web.DownloadController">
        <property name="uploadManagerService">
            <ref bean="uploadManagerService"/>
        </property>
    </bean>

    <!-- Logout Controller -->
    <bean name="logoutController" class="ru.sgnhp.web.LogoutController" />

    <!-- Register Task Form Controller-->
    <bean name="newTaskFormController" class="ru.sgnhp.web.RegisterTaskFormController" >
        <property name="sessionForm">
            <value>true</value>
        </property>
        <property name="commandName">
            <value>registerTask</value>
        </property>
        <property name="commandClass">
            <value>ru.sgnhp.domain.TaskBean</value>
        </property>
        <!--<property name="validator">
            <ref bean="registerTaskFormValidator"/>
        </property>-->
        <property name="formView">
            <value>registerTask</value>
        </property>
        <property name="successView">
            <value>upload.htm</value>
        </property>
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
        <property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>
    </bean>

    <!-- Select Users Form Controller-->
    <bean name="selectUsersFormController" class="ru.sgnhp.web.SelectUsersFormController" >
        <property name="userManagerService">
            <ref bean="userManagerService" />
        </property>
    </bean>

    <!-- Upload Controller-->
    <bean name="uploadController" class="ru.sgnhp.web.UploadController" >
        <property name="commandName" value="fileUpload"/>
        <property name="commandClass" value="ru.sgnhp.domain.FileUploadBean"/>
        <property name="formView" value="upload" />
        <property name="successView" value="index.htm" />
        <property name="uploadManagerService">
            <ref bean="uploadManagerService"/>
        </property>
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
        <property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>
    </bean>

    <!-- Success Controller-->
    <bean id="successController" class="org.springframework.web.servlet.mvc.ParameterizableViewController" p:viewName="success" />

    <!-- Login Form Controller-->
    <bean name="loginFormController" class="ru.sgnhp.web.LoginFormController" >
        <property name="sessionForm">
            <value>true</value>
        </property>
        <property name="commandName">
            <value>userLogin</value>
        </property>
        <property name="commandClass">
            <value>ru.sgnhp.domain.UserLogin</value>
        </property>
        <property name="validator">
            <ref bean="loginFormValidator"/>
        </property>
        <property name="formView">
            <value>login</value>
        </property>
        <property name="successView">
            <value>index.htm</value>
        </property>
        <property name="authenticationDAO">
            <ref bean="authenticationDAO" />
        </property>
    </bean>

    <!--Assigned Task Controller-->
    <bean name="assignedTaskViewController" class="ru.sgnhp.web.AssignedTaskViewController" >
        <!--<property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>-->
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!--Completed Task Controller-->
    <bean name="completedTaskController" class="ru.sgnhp.web.CompletedTaskController" >
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!-- Assign Task Form Controller -->
    <bean name="assingTaskFormController" class="ru.sgnhp.web.AssignWorkflowFormController">
        <property name="commandName" value="assignWorkflow"/>
        <property name="commandClass" value="ru.sgnhp.domain.WorkflowBean"/>
        <property name="formView">
            <value>assignWorkflow</value>
        </property>
        <property name="successView">
            <value>index.htm</value>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!-- Workflow Manager Form Controller -->
    <bean name="workflowManagerFormController" class="ru.sgnhp.web.WorkflowManagerFormController">
        <property name="commandName" value="workflowManager"/>
        <property name="commandClass" value="ru.sgnhp.domain.WorkflowBean"/>
        <property name="formView">
            <value>workflowManager</value>
        </property>
        <property name="successView">
            <value>index.htm</value>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!--========================== Validators ===============================-->

    <bean id="registerTaskFormValidator" class="ru.sgnhp.web.validator.RegisterTaskFormValidator">
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
    </bean>

    <bean id="loginFormValidator" class="ru.sgnhp.web.validator.LoginFormValidator">
        <property name="authenticationDAO">
            <ref bean="authenticationDAO" />
        </property>
    </bean>

    <!--============================== DAO ==================================-->

    <!--User DAO-->
    <bean id="userDao" class="ru.sgnhp.dao.impl.UserDaoImpl">
        <property name="dataSource" ref="dataSource"/>
        <property name="workflowManagerService" ref="workflowManagerService"/>
    </bean>

    <!--User Manager service target bean-->
    <bean id="userManagerServiceTarget" class="ru.sgnhp.service.impl.UserManagerServiceImpl">
        <property name="userDao" ref="userDao"/>
        <property name="workflowManagerService" ref="workflowManagerService"/>
    </bean>

    <!--Task DAO-->
    <bean id="taskDao" class="ru.sgnhp.dao.impl.TaskDaoImpl">
        <property name="dataSource" ref="dataSource"/>
        <property name="uploadManagerService" ref="uploadManagerService"/>
    </bean>

    <!--Task Manager service target bean-->
    <bean id="taskManagerServiceTarget" class="ru.sgnhp.service.impl.TaskManagerServiceImpl">
        <property name="taskDao" ref="taskDao"/>
    </bean>

    <!--Workflow DAO-->
    <bean id="workflowDao" class="ru.sgnhp.dao.impl.WorkflowDaoImpl">
        <property name="dataSource" ref="dataSource"/>
        <property name="taskManagerService" ref="taskManagerService"/>
    </bean>

    <!--Workflow Manager service target bean-->
    <bean id="workflowManagerServiceTarget" class="ru.sgnhp.service.impl.WorkflowManagerServiceImpl">
        <property name="workflowDao" ref="workflowDao"/>
        <property name="userManagerService" ref="userManagerServiceTarget" />
        <property name="stateManagerService" ref="stateManagerServiceTarget" />
        <property name="mailHostName" value="${mail.mailHostName}"/>
        <property name="fromAddress" value="${mail.fromAddress}"/>
        <property name="fromName" value="${mail.fromName}" />
    </bean>

    <!--Upload DAO-->
    <bean id="uploadDao" class="ru.sgnhp.dao.impl.UploadDaoImpl">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    
    <!--Upload Manager service target bean-->
    <bean id="uploadManagerServiceTarget" class="ru.sgnhp.service.impl.UploadManagerServiceImpl">
        <property name="uploadDao" ref="uploadDao"/>
    </bean>

    <bean id="authenticationDAO" class="ru.sgnhp.dao.impl.AuthenticationDaoImpl" />

    <!--State DAO-->
    <bean id="stateDao" class="ru.sgnhp.dao.impl.StateDaoImpl">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <!--State Manager service target bean-->
    <bean id="stateManagerServiceTarget" class="ru.sgnhp.service.impl.StateManagerServiceImpl">
        <property name="stateDao" ref="stateDao"/>
    </bean>

    <!-- =================================================================== -->
    <!-- Transaction-wrapped Services                                        -->
    <!-- =================================================================== -->

    <!-- User Manager Sevice -->
    <bean id="userManagerService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="target" ref="userManagerServiceTarget"/>
        <property name="transactionAttributes">
            <props>
                <prop key="get*">PROPAGATION_REQUIRED,readOnly</prop>
                <prop key="register*">PROPAGATION_REQUIRED</prop>
                <prop key="add*">PROPAGATION_REQUIRED</prop>
                <prop key="save*">PROPAGATION_REQUIRED</prop>
                <prop key="update*">PROPAGATION_REQUIRED</prop>
                <prop key="delete*">PROPAGATION_REQUIRED</prop>
            </props>
        </property>
    </bean>

    <!-- Task Manager Sevice -->
    <bean id="taskManagerService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="target" ref="taskManagerServiceTarget"/>
        <property name="transactionAttributes">
            <props>
                <prop key="get*">PROPAGATION_REQUIRED,readOnly</prop>
                <prop key="add*">PROPAGATION_REQUIRED</prop>
                <prop key="assign*">PROPAGATION_REQUIRED</prop>
                <prop key="save*">PROPAGATION_REQUIRED</prop>
                <prop key="update*">PROPAGATION_REQUIRED</prop>
                <prop key="delete*">PROPAGATION_REQUIRED</prop>
            </props>
        </property>
    </bean>

    <!-- Workflow Manager Sevice -->
    <bean id="workflowManagerService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="target" ref="workflowManagerServiceTarget"/>
        <property name="transactionAttributes">
            <props>
                <prop key="get*">PROPAGATION_REQUIRED,readOnly</prop>
                <prop key="add*">PROPAGATION_REQUIRED</prop>
                <prop key="assign*">PROPAGATION_REQUIRED</prop>
                <prop key="save*">PROPAGATION_REQUIRED</prop>
                <prop key="update*">PROPAGATION_REQUIRED</prop>
                <prop key="delete*">PROPAGATION_REQUIRED</prop>
            </props>
        </property>
    </bean>

    <!-- Upload Manager Sevice -->
    <bean id="uploadManagerService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="target" ref="uploadManagerServiceTarget"/>
        <property name="transactionAttributes">
            <props>
                <prop key="get*">PROPAGATION_REQUIRED,readOnly</prop>
                <prop key="add*">PROPAGATION_REQUIRED</prop>
                <prop key="save*">PROPAGATION_REQUIRED</prop>
                <prop key="update*">PROPAGATION_REQUIRED</prop>
                <prop key="delete*">PROPAGATION_REQUIRED</prop>
            </props>
        </property>
    </bean>

    <!-- State Manager Sevice -->
    <bean id="stateManagerService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="target" ref="stateManagerServiceTarget"/>
        <property name="transactionAttributes">
            <props>
                <prop key="get*">PROPAGATION_REQUIRED,readOnly</prop>
            </props>
        </property>
    </bean>

    <!--============================== NTLM =================================-->

    <!--<bean class="ru.sgnhp.NTAuthProvider" singleton="true" id="NTAuthProvider">
        <property name="domainController">
            <value>10.1.32.1</value>
        </property>
        <property name="defaultDomain">
            <value>snos.ru</value>
        </property>
    </bean>
    <bean class="ru.sgnhp.NtlmHttpFilter" singleton="true" id="ntlmHttpFilter">
        <property name="authProvider">
            <ref bean="NTAuthProvider"/>
        </property>
        <property name="enableInsecureBasic">
            <value>true</value>
        </property>
        <property name="enableSecureBasic">
            <value>true</value>
        </property>
        <property name="realm">
            <value>xidea portal</value>
        </property>
        <property name="exclusionPatterns">
            <list>
                <value>/security/*</value>
                <value>/document/styles/*</value>
                <value>/document/images/*</value>
            </list>
        </property>
        <property name="loginPage">
            <value>/security/login.action</value>
        </property>
    </bean>-->

    <!--============================== File Upload ==========================-->

    <!-- MultipartResolver for parsing file uploads, implementation for Commons FileUpload -->
    <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
        <property name="maxUploadSize" value="1024000000"/>
    </bean>

    <!--============================== Sheduling  ===========================-->

    <bean id="simpleService" class="ru.sgnhp.sheduling.impl.SimpleWorkServiceImpl"/>

    <bean id="methodInvokingJobDetail" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
        <property name="targetObject" ref="workflowManagerService"/>
        <property name="targetMethod" value="taskReminder"/>
    </bean>

 <!--
 Here are some full examples:

Expression	 Meaning
0 0 12 * * ?	 Fire at 12pm (noon) every day
0 15 10 ? * *	 Fire at 10:15am every day
0 15 10 * * ?	 Fire at 10:15am every day
0 15 10 * * ? *	 Fire at 10:15am every day
0 15 10 * * ? 2005	 Fire at 10:15am every day during the year 2005
0 * 14 * * ?	 Fire every minute starting at 2pm and ending at 2:59pm, every day
0 0/5 14 * * ?	 Fire every 5 minutes starting at 2pm and ending at 2:55pm, every day
0 0/5 14,18 * * ?	 Fire every 5 minutes starting at 2pm and ending at 2:55pm, AND fire every 5 minutes starting at 6pm and ending at 6:55pm, every day
0 0-5 14 * * ?	 Fire every minute starting at 2pm and ending at 2:05pm, every day
0 10,44 14 ? 3 WED	 Fire at 2:10pm and at 2:44pm every Wednesday in the month of March.
0 15 10 ? * MON-FRI	 Fire at 10:15am every Monday, Tuesday, Wednesday, Thursday and Friday
0 15 10 15 * ?	 Fire at 10:15am on the 15th day of every month
0 15 10 L * ?	 Fire at 10:15am on the last day of every month
0 15 10 ? * 6L	 Fire at 10:15am on the last Friday of every month
0 15 10 ? * 6L	 Fire at 10:15am on the last Friday of every month
0 15 10 ? * 6L 2002-2005	 Fire at 10:15am on every last friday of every month during the years 2002, 2003, 2004 and 2005
0 15 10 ? * 6#3	 Fire at 10:15am on the third Friday of every month
0 0 12 1/5 * ?	 Fire at 12pm (noon) every 5 days every month, starting on the first day of the month.
0 11 11 11 11 ?	 Fire every November 11th at 11:11am.
 -->

    <bean id="cronTrigger" class="org.springframework.scheduling.quartz.CronTriggerBean">
        <property name="jobDetail">
            <ref bean="methodInvokingJobDetail"/>
        </property>
        <property name="cronExpression">
            <value>0 0 15 ? * MON-FRI</value>
        </property>
    </bean>

    <bean class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
        <property name="triggers">
            <list>
                <ref bean="cronTrigger" />
            </list>
        </property>
    </bean>

</beans>