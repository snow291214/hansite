<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">

    <bean class="org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"/>

    <bean id="propertyConfigurer"
          class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"
          p:location="/WEB-INF/classes/mail.properties"/>

    <bean id="urlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
        <property name="mappings">
            <props>
                <prop key="index.htm">indexController</prop>
                <prop key="logout.htm">logoutController</prop>
                <prop key="download.htm">downloadController</prop>
                <prop key="selectUsers.htm">selectUsersFormController</prop>
                <prop key="registerTask.htm">newTaskFormController</prop>
                <prop key="upload.htm">uploadController</prop>
                <prop key="success.htm">successController</prop>
                <prop key="authentication.htm">loginFormController</prop>
                <prop key="assignedTask.htm">assignedTaskViewController</prop>
                <prop key="completedTask.htm">completedTaskController</prop>
                <prop key="assignTask.htm">assingTaskFormController</prop>
                <prop key="workflowManager.htm">workflowManagerFormController</prop>
                <prop key="executionRequest.htm">executionRequestController</prop>
                <prop key="searchTask.htm">searchTaskFormController</prop>
                <prop key="searchResult.htm">searchResultController</prop>
                <prop key="ajax.htm">ajaxController</prop>
                <prop key="roadmap.htm">roadmapController</prop>
                <prop key="outgoingLetterWizard.htm">outgoingLetterController</prop>
            </props>
        </property>
    </bean>

    <bean id="viewResolver"
          class="org.springframework.web.servlet.view.InternalResourceViewResolver"
          p:prefix="/WEB-INF/jsp/"
          p:suffix=".jsp" />

    <!--========================= Controllers ===============================-->

    <!-- Login Form Controller-->
    <bean name="loginFormController"
          class="org.springframework.web.servlet.mvc.ParameterizableViewController"
          p:viewName="login" />
    <!--<bean name="loginFormController" class="ru.sgnhp.web.LoginFormController" >
        <property name="sessionForm">
            <value>true</value>
        </property>
        <property name="commandName">
            <value>userLogin</value>
        </property>
        <property name="commandClass">
            <value>ru.sgnhp.dto.UserLogin</value>
        </property>
        <property name="validator">
            <ref bean="loginFormValidator"/>
        </property>
        <property name="formView">
            <value>login</value>
        </property>
        <property name="successView">
            <value>index.htm</value>
        </property>
        <property name="authenticationDAO">
            <ref bean="authenticationDAO" />
        </property>
    </bean>-->

    <!-- Index Controller -->
    <bean name="indexController" class="ru.sgnhp.web.IndexController" >
        <property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!-- Execution Request Controller -->
    <bean name="executionRequestController" class="ru.sgnhp.web.ExecutionRequestController">
        <property name="mailService">
            <ref bean="mailServiceManager"/>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!-- Download Controller -->
    <bean name="downloadController" class="ru.sgnhp.web.DownloadController">
        <property name="uploadManagerService">
            <ref bean="uploadManagerService"/>
        </property>
    </bean>

    <!-- Logout Controller -->
    <bean name="logoutController" class="ru.sgnhp.web.LogoutController" />

    <!-- Register Task Form Controller-->
    <bean name="newTaskFormController" class="ru.sgnhp.web.RegisterTaskFormController" >
        <property name="sessionForm">
            <value>true</value>
        </property>
        <property name="commandName">
            <value>registerTask</value>
        </property>
        <property name="commandClass">
            <value>ru.sgnhp.domain.TaskBean</value>
        </property>
        <property name="validator">
            <ref bean="registerTaskFormValidator"/>
        </property>
        <property name="formView">
            <value>registerTask</value>
        </property>
        <property name="successView">
            <value>upload.htm</value>
        </property>
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
        <property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>
        <property name="stateManagerService">
            <ref bean="stateManagerService"/>
        </property>
    </bean>

    <!-- Select Users Form Controller-->
    <bean name="selectUsersFormController" class="ru.sgnhp.web.SelectUsersFormController" >
        <property name="userManagerService">
            <ref bean="userManagerService" />
        </property>
    </bean>

    <!-- Upload Controller-->
    <bean name="uploadController" class="ru.sgnhp.web.UploadController" >
        <property name="commandName" value="fileUpload"/>
        <property name="commandClass" value="ru.sgnhp.domain.FileBean"/>
        <property name="formView" value="upload" />
        <property name="successView" value="index.htm" />
        <property name="uploadManagerService">
            <ref bean="uploadManagerService"/>
        </property>
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
        <property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>
        <property name="stateManagerService">
            <ref bean="stateManagerService"/>
        </property>
    </bean>

    <!-- Success Controller-->
    <bean id="successController" class="org.springframework.web.servlet.mvc.ParameterizableViewController" p:viewName="success" />

    <!--Assigned Task Controller-->
    <bean name="assignedTaskViewController" class="ru.sgnhp.web.AssignedTaskViewController" >
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!--Completed Task Controller-->
    <bean name="completedTaskController" class="ru.sgnhp.web.CompletedTaskController" >
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <!-- Assign Task Form Controller -->
    <bean name="assingTaskFormController" class="ru.sgnhp.web.AssignWorkflowFormController">
        <property name="commandName" value="assignWorkflow"/>
        <property name="commandClass" value="ru.sgnhp.dto.WorkflowBeanDto"/>
        <property name="formView">
            <value>assignWorkflow</value>
        </property>
        <property name="successView">
            <value>index.htm</value>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
        <property name="userManagerService">
            <ref bean="userManagerService"/>
        </property>
        <property name="stateManagerService">
            <ref bean="stateManagerService"/>
        </property>
    </bean>

    <!-- Workflow Manager Form Controller -->
    <bean name="workflowManagerFormController" class="ru.sgnhp.web.WorkflowManagerFormController">
        <property name="commandName" value="workflowManager"/>
        <property name="commandClass" value="ru.sgnhp.dto.WorkflowBeanDto"/>
        <property name="formView">
            <value>workflowManager</value>
        </property>
        <property name="successView">
            <value>index.htm</value>
        </property>
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
        <property name="stateManagerService">
            <ref bean="stateManagerService"/>
        </property>
    </bean>

    <!-- Search Task Controller -->
    <bean name="searchTaskFormController" class="ru.sgnhp.web.SearchTaskFormController">
        <property name="commandName" value="searchTask"/>
        <property name="commandClass" value="ru.sgnhp.dto.SearchTaskDto"/>
        <property name="formView">
            <value>searchTask</value>
        </property>
        <property name="successView">
            <value>searchResult.htm</value>
        </property>
    </bean>

    <!-- Search Result Controller -->
    <bean name="searchResultController" class="ru.sgnhp.web.SearchResultController">
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
    </bean>

    <!-- Ajax Controller -->
    <bean name="ajaxController" class="ru.sgnhp.web.AjaxController">
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
    </bean>

    <!-- Workflow Roadmap Controller -->
    <bean name="roadmapController" class="ru.sgnhp.web.RoadmapController">
        <property name="workflowManagerService">
            <ref bean="workflowManagerService"/>
        </property>
    </bean>

    <bean name="outgoingLetterController" class="ru.sgnhp.web.OutgoingLetterController">
        <property name="commandName">
            <value>outgoingMailDto</value>
        </property>
        <property name="commandClass">
            <value>ru.sgnhp.dto.OutgoingMailDto</value>
        </property>
        <property name="pages">
            <list>
                <value>outgoingLetterRegister</value>
                <value>outgoingFileRegister</value>
                <value>redirect:index.htm</value>
            </list>
        </property>
    </bean>

    <!--========================== Validators ===============================-->

    <bean id="registerTaskFormValidator" class="ru.sgnhp.web.validator.RegisterTaskFormValidator">
        <property name="taskManagerService">
            <ref bean="taskManagerService"/>
        </property>
    </bean>

    <bean id="loginFormValidator" class="ru.sgnhp.web.validator.LoginFormValidator">
        <property name="authenticationDAO">
            <ref bean="authenticationDAO" />
        </property>
    </bean>
    
    <!--======================== Authentication =============================-->
    <bean id="authenticationDAO" class="ru.sgnhp.dao.impl.AuthenticationDaoImpl" />

    <!--============================== File Upload ==========================-->
    <!-- MultipartResolver for parsing file uploads, implementation for Commons FileUpload -->
    <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
        <property name="maxUploadSize" value="1024000000"/>
    </bean>

    <!--============================== Sheduling  ===========================-->

    <bean id="methodInvokingJobDetail" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
        <property name="targetObject" ref="workflowManagerService"/>
        <property name="targetMethod" value="taskReminder"/>
    </bean>

 <!--
 Here are some full examples:

Expression	 Meaning
0 0 12 * * ?	 Fire at 12pm (noon) every day
0 15 10 ? * *	 Fire at 10:15am every day
0 15 10 * * ?	 Fire at 10:15am every day
0 15 10 * * ? *	 Fire at 10:15am every day
0 15 10 * * ? 2005	 Fire at 10:15am every day during the year 2005
0 * 14 * * ?	 Fire every minute starting at 2pm and ending at 2:59pm, every day
0 0/5 14 * * ?	 Fire every 5 minutes starting at 2pm and ending at 2:55pm, every day
0 0/5 14,18 * * ?	 Fire every 5 minutes starting at 2pm and ending at 2:55pm, AND fire every 5 minutes starting at 6pm and ending at 6:55pm, every day
0 0-5 14 * * ?	 Fire every minute starting at 2pm and ending at 2:05pm, every day
0 10,44 14 ? 3 WED	 Fire at 2:10pm and at 2:44pm every Wednesday in the month of March.
0 15 10 ? * MON-FRI	 Fire at 10:15am every Monday, Tuesday, Wednesday, Thursday and Friday
0 15 10 15 * ?	 Fire at 10:15am on the 15th day of every month
0 15 10 L * ?	 Fire at 10:15am on the last day of every month
0 15 10 ? * 6L	 Fire at 10:15am on the last Friday of every month
0 15 10 ? * 6L	 Fire at 10:15am on the last Friday of every month
0 15 10 ? * 6L 2002-2005	 Fire at 10:15am on every last friday of every month during the years 2002, 2003, 2004 and 2005
0 15 10 ? * 6#3	 Fire at 10:15am on the third Friday of every month
0 0 12 1/5 * ?	 Fire at 12pm (noon) every 5 days every month, starting on the first day of the month.
0 11 11 11 11 ?	 Fire every November 11th at 11:11am.
 -->

    <bean id="cronTrigger" class="org.springframework.scheduling.quartz.CronTriggerBean">
        <property name="jobDetail">
            <ref bean="methodInvokingJobDetail"/>
        </property>
        <property name="cronExpression">
            <value>0 00 8 ? * MON-FRI</value>
        </property>
    </bean>

    <bean class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
        <property name="triggers">
            <list>
                <ref bean="cronTrigger" />
            </list>
        </property>
    </bean>
</beans>